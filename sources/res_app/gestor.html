<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Previsional Soberano v2.1</title>
    <style>
        :root { --blue: #1a73e8; --green: #34a853; --red: #d93025; --gray: #5f6368; --light-blue: #e8f0fe; }
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 30px; }
        header { background: var(--blue); color: white; padding: 15px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        nav { background: white; display: flex; justify-content: space-around; padding: 10px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 10; }
        .nav-item { cursor: pointer; color: var(--blue); font-weight: bold; font-size: 0.9em; padding: 5px 10px; }
        .container { padding: 15px; max-width: 700px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .hidden { display: none !important; }
        label { display: block; font-weight: bold; margin-top: 10px; font-size: 0.8em; color: var(--gray); text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .btn { border: none; padding: 14px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 14px; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn-outline { background: none; border: 1px solid var(--blue); color: var(--blue); }
        .row { display: flex; gap: 10px; align-items: flex-end; }
        .resumen-laboral { background: var(--light-blue); padding: 15px; border-radius: 8px; margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .resumen-dato { text-align: center; }
        .resumen-dato span { display: block; font-size: 1.2em; font-weight: bold; color: var(--blue); }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 20px; border-radius: 10px; z-index: 1000; }
    </style>
</head>
<body>

<header>SISTEMA GESTOR PREVISIONAL</header>

<div id="loading" class="hidden">PROCESANDO...</div>

<div id="login-screen" class="container">
    <div class="card">
        <h3>Iniciar Sesi贸n</h3>
        <label>PIN de Acceso</label>
        <input type="password" id="pass-input">
        <button class="btn btn-blue" onclick="ejecutarLogin()">INGRESAR</button>
    </div>
</div>

<div id="main-app" class="hidden">
    <nav>
        <span class="nav-item" onclick="mostrarSeccion('form')"> FICHA Y CMPUTO</span>
        <span class="nav-item" onclick="mostrarSeccion('agenda')"> AGENDA</span>
        <span class="nav-item" style="color:var(--red);" onclick="cerrarSesion()"> SALIR</span>
    </nav>

    <div id="sec-form" class="container">
        <div class="card">
            <h3>Ficha del Cliente</h3>
            <div class="row">
                <div style="flex:1"><label>DNI</label><input type="number" id="dni"></div>
                <button class="btn btn-blue" style="width:60px; margin:0;" onclick="consultarExpediente()"></button>
            </div>
            <label>Nombre y Apellido</label>
            <input type="text" id="nombre" class="master-field">
            <div class="row">
                <div style="flex:1"><label>Nacimiento</label><input type="date" id="fecha_nac" onchange="actualizarEdad()"></div>
                <div style="flex:1"><label>Edad</label><div id="edad-display" style="padding:12px; font-weight:bold; color:var(--blue);">-</div></div>
            </div>
            <div class="row">
                <div style="flex:1"><label>CUIL</label><input type="text" id="cuil"></div>
                <div style="flex:1"><label>Hijos</label><input type="number" id="hijos"></div>
            </div>
        </div>

        <div class="card">
            <h3>C贸mputo de Datos Laborales</h3>
            <label>S谩bana Pre-94</label>
            <textarea id="inputPre94" placeholder="Pegue datos anteriores al 06/94..." rows="3"></textarea>
            
            <label>S谩bana Post-94</label>
            <textarea id="inputPost94" placeholder="Pegue datos posteriores al 07/94..." rows="3"></textarea>
            
            <button class="btn btn-outline" onclick="ejecutarComputo()"> GENERAR RESUMEN LABORAL</button>

            <div id="panel-resumen" class="resumen-laboral hidden">
                <div class="resumen-dato">
                    <label>Aportes Totales</label>
                    <span id="res-total">0a 0m</span>
                </div>
                <div class="resumen-dato">
                    <label>Promedio Rem.</label>
                    <span id="res-promedio">$0.00</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Estado y Moratorias</h3>
            <div id="moratorias-wrapper"></div>
            <button class="btn btn-outline" onclick="crearGrupoMoratoria()">+ Agregar Plan</button>
            
            <label>Estado Tr谩mite</label>
            <select id="estado_tramite">
                <option>Iniciado</option>
                <option>En C贸mputos</option>
                <option>Acordado</option>
            </select>
            <label>Notas</label>
            <textarea id="notas" rows="3"></textarea>
            
            <button class="btn btn-green" onclick="enviarDatos()"> GUARDAR EXPEDIENTE COMPLETO</button>
            <button class="btn btn-outline" style="color:var(--red); border-color:var(--red);" onclick="limpiarFormulario()">LIMPIAR PANTALLA</button>
        </div>
    </div>

    <div id="sec-agenda" class="container hidden">
        <button class="btn btn-blue" onclick="cargarAgenda()"> ACTUALIZAR LISTADO</button>
        <div id="agenda-lista" style="margin-top:15px;"></div>
    </div>
</div>
<script>
// ==========================================
// CONFIGURACIN Y VARIABLES GLOBALES
// ==========================================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwLdk4j2Pc7Ng88TunAhNTveET1SDgDIcm-JVgXxNxLkMWReNYDB3JLf5-4o2lQE0T-/exec";
let USER_ROLE = "";
let lineaDeTiempo = new Map();
let remuneracionesParaPromedio = [];
let timeoutReloj;
const MINUTOS_INACTIVIDAD = 15;

// ==========================================
// 1. LGICA DE CMPUTO LABORAL (REGEX)
// ==========================================
function ejecutarComputo() {
    lineaDeTiempo.clear();
    remuneracionesParaPromedio = [];
    
    procesarPre94();
    procesarPost94();
    
    const totalMeses = lineaDeTiempo.size;
    const anios = Math.floor(totalMeses / 12);
    const meses = totalMeses % 12;
    
    document.getElementById('res-total').innerText = `${anios}a ${meses}m`;
    
    const ultimas120 = remuneracionesParaPromedio.slice(-120);
    const suma = ultimas120.reduce((acc, curr) => acc + curr.monto, 0);
    const promedio = ultimas120.length > 0 ? suma / ultimas120.length : 0;
    
    document.getElementById('res-promedio').innerText = `$${promedio.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
    document.getElementById('panel-resumen').classList.remove('hidden');
}

function procesarPre94() {
    const texto = document.getElementById('inputPre94').value;
    const regex = /^(.+?)\s+(\d+)\s+(\d{4})\s+\d+\s+(\d{2})\/(\d{2})\s*-\s*\d{2}\/\d{2}\s+(\d+)/gm;
    let match;
    while ((match = regex.exec(texto)) !== null) {
        const [_, emp, cta, anio, dia, mes, cant] = match;
        for (let i = 0; i < parseInt(cant); i++) {
            let m = parseInt(mes) + i;
            let a = parseInt(anio);
            while (m > 12) { m -= 12; a += 1; }
            lineaDeTiempo.set(`${m.toString().padStart(2,'0')}/${a}`, { emp });
        }
    }
}

function procesarPost94() {
    const texto = document.getElementById('inputPost94').value;
    const regex = /^(.+?)\s+[\d-]+\s+[EC]\s*[A-Z]?\s+(\d{2}\/\d{4})\s+\d+\s+\d+\s+([\d.,]+)\s+[\d.,]+\s+[\d.,]+\s+([\d.,]+)/gm;
    let match;
    while ((match = regex.exec(texto)) !== null) {
        const [_, emp, periodo, remTotalStr, sacStr] = match;
        const rem = parseFloat(remTotalStr.replace(/\./g, '').replace(',', '.'));
        const sac = parseFloat(sacStr.replace(/\./g, '').replace(',', '.'));
        lineaDeTiempo.set(periodo, { emp });
        if (sac === 0) remuneracionesParaPromedio.push({ monto: rem });
    }
}

// ==========================================
// 2. GESTIN DE EXPEDIENTES (CRUD)
// ==========================================

async function consultarExpediente() {
    const dni = document.getElementById('dni').value;
    if(!dni) return alert("Ingresa un DNI");
    toggleLoad(true);
    try {
        const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "consultarDNI", dni: dni }) });
        const res = await r.json();
        if(res) {
            // Mapeo seg煤n Estructura ver_02 (17 columnas)
            document.getElementById('nombre').value = res[2] || "";
            
            if (res[3]) { // Fecha Nacimiento
                const fechaObj = new Date(res[3]);
                const ano = fechaObj.getFullYear();
                const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
                const dia = String(fechaObj.getDate()).padStart(2, '0');
                document.getElementById('fecha_nac').value = `${ano}-${mes}-${dia}`;
            }

            document.getElementById('cuil').value = res[4] || "";
            document.getElementById('clave_anses').value = res[5] || "";
            document.getElementById('estado_civil').value = res[6] || "Soltero/a";
            document.getElementById('hijos').value = res[7] || "";
            document.getElementById('estado_tramite').value = res[8] || "Iniciado";
            
            // Moratorias
            document.getElementById('moratorias-wrapper').innerHTML = "";
            JSON.parse(res[9] || "[]").forEach(m => crearGrupoMoratoria(m));
            
            document.getElementById('notas').value = res[10] || "";
            
            // Datos Laborales (Nuevas columnas L, M, N, O)
            document.getElementById('res-total').innerText = res[11] || "0a 0m";
            document.getElementById('res-promedio').innerText = res[12] || "$0.00";
            document.getElementById('inputPre94').value = res[13] || "";
            document.getElementById('inputPost94').value = res[14] || "";

            if(res[11]) document.getElementById('panel-resumen').classList.remove('hidden');

            actualizarEdad();
            alert("Datos cargados correctamente");
        } else { alert("DNI no encontrado"); }
    } catch (e) { alert("Error al buscar"); }
    toggleLoad(false);
}

async function enviarDatos() {
    const dni = document.getElementById('dni').value;
    if(!dni) return alert("Falta el DNI");
    toggleLoad(true);

    const moratorias = Array.from(document.querySelectorAll('.moratoria-item')).map(it => ({
        ley: it.querySelector('.m-ley').value,
        pactadas: it.querySelector('.m-pact').value,
        pagas: it.querySelector('.m-pagas').value
    }));

    const payload = {
        action: "guardarExpediente",
        dni: dni,
        nombre: document.getElementById('nombre').value,
        fecha_nac: document.getElementById('fecha_nac').value,
        cuil: document.getElementById('cuil').value,
        clave_anses: document.getElementById('clave_anses').value,
        estado_civil: document.getElementById('estado_civil').value,
        hijos: document.getElementById('hijos').value,
        estado: document.getElementById('estado_tramite').value,
        moratorias: JSON.stringify(moratorias),
        notas: document.getElementById('notas').value,
        resumen_aportes: document.getElementById('res-total').innerText,
        promedio_rem: document.getElementById('res-promedio').innerText,
        sabana_pre: document.getElementById('inputPre94').value,
        sabana_post: document.getElementById('inputPost94').value,
        usuario: USER_ROLE 
    };

    try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        alert("Guardado exitoso");
    } catch (e) { alert("Error al guardar"); }
    toggleLoad(false);
}

// ==========================================
// 3. AUXILIARES, LOGIN Y NAVEGACIN
// ==========================================

async function ejecutarLogin() {
    const pin = document.getElementById('pass-input').value;
    toggleLoad(true);
    try {
        const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "login", pin: pin }) });
        const res = await r.json();
        if (res.success) {
            USER_ROLE = res.role;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            if(USER_ROLE === "RESTRINGIDO") document.querySelectorAll('.master-field').forEach(el => el.disabled = true);
            resetearTemporizador();
        } else { alert("PIN Incorrecto"); }
    } catch (e) { alert("Error de conexi贸n"); }
    toggleLoad(false);
}

function mostrarSeccion(sec) {
    document.getElementById('sec-form').classList.add('hidden');
    document.getElementById('sec-agenda').classList.add('hidden');
    document.getElementById('sec-' + sec).classList.remove('hidden');
    if(sec === 'agenda') cargarAgenda();
}

function actualizarEdad() {
    const f = document.getElementById('fecha_nac').value;
    if(!f) return;
    const n = new Date(f);
    const h = new Date();
    let e = h.getFullYear() - n.getFullYear();
    if (h.getMonth() < n.getMonth() || (h.getMonth() === n.getMonth() && h.getDate() < n.getDate())) e--;
    document.getElementById('edad-display').innerText = e + " a帽os";
}

function limpiarFormulario() {
    document.querySelectorAll('input, textarea').forEach(i => i.value = "");
    document.getElementById('moratorias-wrapper').innerHTML = "";
    document.getElementById('edad-display').innerText = "-";
    document.getElementById('panel-resumen').classList.add('hidden');
    document.getElementById('res-total').innerText = "0a 0m";
    document.getElementById('res-promedio').innerText = "$0.00";
}

function crearGrupoMoratoria(d = {}) {
    const div = document.createElement('div');
    div.style = "border:1px solid #ddd; padding:10px; margin-top:10px; background:#f9f9f9; position:relative;";
    div.className = "moratoria-item";
    div.innerHTML = `
        <label>Ley</label><input type="text" class="m-ley" value="${d.ley||''}">
        <div class="row">
            <div style="flex:1"><label>Pactadas</label><input type="number" class="m-pact" value="${d.pactadas||''}"></div>
            <div style="flex:1"><label>Pagas</label><input type="number" class="m-pagas" value="${d.pagas||''}"></div>
        </div>
        <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer; font-size:11px; margin-top:5px;">[Eliminar Plan]</button>
    `;
    document.getElementById('moratorias-wrapper').appendChild(div);
}

async function cargarAgenda() {
    toggleLoad(true);
    const lista = document.getElementById('agenda-lista');
    lista.innerHTML = "";
    try {
        const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "listarTodo" }) });
        const datos = await r.json();
        datos.forEach(c => {
            const item = document.createElement('div');
            item.className = "agenda-card";
            item.innerHTML = `
                <strong>${c[2]}</strong> (DNI: ${c[1]})<br>
                <small>Estado: ${c[8]} | Aportes: ${c[11] || 'Sin c贸mputo'}</small>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-blue" style="padding:5px; font-size:11px;" onclick="editarDesdeAgenda('${c[1]}')">EDITAR</button>
                    ${USER_ROLE === 'MAESTRO' ? `<button class="btn btn-red" style="padding:5px; font-size:11px;" onclick="borrarExpediente('${c[1]}')">BORRAR</button>` : ''}
                </div>
            `;
            lista.appendChild(item);
        });
    } catch (e) { alert("Error al listar agenda"); }
    toggleLoad(false);
}

async function borrarExpediente(dni) {
    if(!confirm("驴Eliminar registro?")) return;
    toggleLoad(true);
    try {
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "borrarExpediente", dni: dni, usuario: USER_ROLE }) });
        cargarAgenda();
    } catch (e) { alert("Error al borrar"); }
    toggleLoad(false);
}

function editarDesdeAgenda(dni) {
    document.getElementById('dni').value = dni;
    consultarExpediente();
    mostrarSeccion('form');
}

function toggleLoad(v) { document.getElementById('loading').className = v ? "" : "hidden"; }

function cerrarSesion() {
    USER_ROLE = "";
    limpiarFormulario();
    document.getElementById('pass-input').value = "";
    document.getElementById('main-app').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
    clearTimeout(timeoutReloj);
}

function resetearTemporizador() {
    clearTimeout(timeoutReloj);
    if (!document.getElementById('main-app').classList.contains('hidden')) {
        timeoutReloj = setTimeout(() => {
            alert("Sesi贸n cerrada por inactividad.");
            cerrarSesion();
        }, MINUTOS_INACTIVIDAD * 60 * 1000);
    }
}

// Eventos de usuario
window.onload = resetearTemporizador;
document.onmousemove = resetearTemporizador;
document.onkeypress = resetearTemporizador;
document.ontouchstart = resetearTemporizador;
</script>

</body>
</html>
