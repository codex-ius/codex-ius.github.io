<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Previsional Soberano v2.1</title>
    <style>
        :root { --blue: #1a73e8; --green: #34a853; --red: #d93025; --gray: #5f6368; --light-blue: #e8f0fe; }
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 30px; }
        header { background: var(--blue); color: white; padding: 15px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        nav { background: white; display: flex; justify-content: space-around; padding: 10px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 10; }
        .nav-item { cursor: pointer; color: var(--blue); font-weight: bold; font-size: 0.9em; padding: 5px 10px; }
        .container { padding: 15px; max-width: 700px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .hidden { display: none !important; }
        label { display: block; font-weight: bold; margin-top: 10px; font-size: 0.8em; color: var(--gray); text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .btn { border: none; padding: 14px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 14px; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn-outline { background: none; border: 1px solid var(--blue); color: var(--blue); }
        .row { display: flex; gap: 10px; align-items: flex-end; }
        .resumen-laboral { background: var(--light-blue); padding: 15px; border-radius: 8px; margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .resumen-dato { text-align: center; }
        .resumen-dato span { display: block; font-size: 1.2em; font-weight: bold; color: var(--blue); }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 20px; border-radius: 10px; z-index: 1000; }
    .resumen-laboral {
    margin-top: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.resumen-laboral table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
}

.resumen-laboral th {
    background-color: var(--blue);
    color: white;
    padding: 8px;
    text-align: left;
}

.resumen-laboral td {
    padding: 8px;
    border-bottom: 1px solid #eee;
}

    </style>
</head>
<body>

<header>SISTEMA GESTOR PREVISIONAL</header>

<div id="loading" class="hidden">PROCESANDO...</div>

<div id="login-screen" class="container">
    <div class="card">
        <h3>Iniciar Sesi贸n</h3>
        <label>PIN de Acceso</label>
        <input type="password" id="pass-input">
        <button class="btn btn-blue" onclick="ejecutarLogin()">INGRESAR</button>
    </div>
</div>

<div id="main-app" class="hidden">
    <nav>
        <span class="nav-item" onclick="mostrarSeccion('form')"> FICHA Y CMPUTO</span>
        <span class="nav-item" onclick="mostrarSeccion('agenda')"> AGENDA</span>
        <span class="nav-item" style="color:var(--red);" onclick="cerrarSesion()"> SALIR</span>
    </nav>

    <div id="sec-form" class="container">
        <div class="card">
            <h3>Ficha del Cliente</h3>
            <div class="row">
                <div style="flex:1"><label>DNI</label><input type="number" id="dni"></div>
                <button class="btn btn-blue" style="width:60px; margin:0;" onclick="consultarExpediente()"></button>
            </div>
            <label>Nombre y Apellido</label>
            <input type="text" id="nombre" class="master-field">
            <div class="row">
                <div style="flex:1"><label>Nacimiento</label><input type="date" id="fecha_nac" onchange="actualizarEdad()"></div>
                <div style="flex:1"><label>Edad</label><div id="edad-display" style="padding:12px; font-weight:bold; color:var(--blue);">-</div></div>
            </div>
            <div class="row">
            <div style="flex:1"><label>CUIL</label><input type="text" id="cuil"></div>
            <div style="flex:1"><label>Clave ANSES</label><input type="text" id="clave_anses"></div> 
            <div style="flex:1"><label>Hijos</label><input type="number" id="hijos"></div>
            </div>

            
        </div>

        <div class="card">
            <h3>C贸mputo de Datos Laborales</h3>
            <label>S谩bana Pre-94</label>
            <textarea id="inputPre94" placeholder="Pegue datos anteriores al 06/94..." rows="3"></textarea>
            
            <label>S谩bana Post-94</label>
            <textarea id="inputPost94" placeholder="Pegue datos posteriores al 07/94..." rows="3"></textarea>
            
            <button class="btn btn-outline" onclick="ejecutarComputo()"> GENERAR RESUMEN LABORAL</button>

            <div id="panel-resumen" class="resumen-laboral hidden" style="overflow-x: auto; padding: 10px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;">
    </div>

        </div>

        <div class="card">
            <h3>Estado y Moratorias</h3>
            <div id="moratorias-wrapper"></div>
            <button class="btn btn-outline" onclick="crearGrupoMoratoria()">+ Agregar Plan</button>
            
            <label>Estado Tr谩mite</label>
            <select id="estado_tramite">
                <option>Iniciado</option>
                <option>En C贸mputos</option>
                <option>Acordado</option>
            </select>
            <label>Notas</label>
            <textarea id="notas" rows="3"></textarea>
            
            <button class="btn btn-green" onclick="enviarDatos()"> GUARDAR EXPEDIENTE COMPLETO</button>
            <button class="btn btn-outline" style="color:var(--red); border-color:var(--red);" onclick="limpiarFormulario()">LIMPIAR PANTALLA</button>
        </div>
    </div>

    <div id="sec-agenda" class="container hidden">
        <button class="btn btn-blue" onclick="cargarAgenda()"> ACTUALIZAR LISTADO</button>
        <div id="agenda-lista" style="margin-top:15px;"></div>
    </div>
</div>
<script>// ==========================================
// CONFIGURACIN Y VARIABLES GLOBALES
// ==========================================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwLdk4j2Pc7Ng88TunAhNTveET1SDgDIcm-JVgXxNxLkMWReNYDB3JLf5-4o2lQE0T-/exec";
let USER_ROLE = "";
let desgloseEmpleadores = {}; 
let timeoutReloj;
const MINUTOS_INACTIVIDAD = 15;

// ==========================================
// 1. LGICA DE CMPUTO LABORAL DISCRIMINADO
// ==========================================
function ejecutarComputo() {
    desgloseEmpleadores = {};
    let remuneracionesUltimas = [];
    const lineaDeTiempoTotal = new Set();

    const textoPost = document.getElementById('inputPost94').value;
    // Regex mejorada: Captura Empresa, CUIT, Especial(D/P), Periodo, Dias, Rem.Total y SAC
    const regexPost = /^(.+?)\s+([\d-]{11,})\s+[EC]\s*([DP])?\s+(\d{2}\/\d{4})\s+(\d+)\s+\d+\s+([\d.,]+)\s+[\d.,]+\s+[\d.,]+\s+([\d.,]+)/gm;
    
    let m;
    while ((m = regexPost.exec(textoPost)) !== null) {
        const [_, empresa, cuit, especial, periodo, dias, totalStr, sacStr] = m;
        const monto = parseFloat(totalStr.replace(/\./g, '').replace(',', '.'));
        const sac = parseFloat(sacStr.replace(/\./g, '').replace(',', '.'));
        const esEspecial = (especial === 'P' || especial === 'D');
        
        lineaDeTiempoTotal.add(periodo);
        
        if (!desgloseEmpleadores[cuit]) {
            desgloseEmpleadores[cuit] = { nombre: empresa, meses: new Set(), remComun: 0, remEspecial: 0 };
        }
        
        desgloseEmpleadores[cuit].meses.add(periodo);
        if (esEspecial) desgloseEmpleadores[cuit].remEspecial += monto;
        else desgloseEmpleadores[cuit].remComun += monto;
        
        if (sac === 0) remuneracionesUltimas.push(monto);
    }

    // Calculamos Promedio (ltimos 120 meses)
    const ultimas120 = remuneracionesUltimas.slice(-120);
    const suma = ultimas120.reduce((a, b) => a + b, 0);
    const promedio = ultimas120.length > 0 ? suma / ultimas120.length : 0;

    renderizarTablaResumen(lineaDeTiempoTotal.size, promedio);
}

function renderizarTablaResumen(totalMeses, promedio) {
    const anios = Math.floor(totalMeses / 12);
    const meses = totalMeses % 12;
    const promedioTxt = promedio.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });

    let tablaHtml = `
        <div style="background:var(--light-blue); padding:10px; border-radius:5px; margin-bottom:10px;">
            <strong>RESUMEN GENERAL:</strong> ${anios} a帽os y ${meses} meses | <strong>Promedio (u120):</strong> ${promedioTxt}
        </div>
        <table style="width:100%; font-size:12px; border-collapse:collapse; background:white;">
            <tr style="background:var(--blue); color:white;">
                <th style="padding:5px; text-align:left;">EMPLEADOR / CUIT</th>
                <th style="padding:5px;">TIEMPO</th>
                <th style="padding:5px;">COMN</th>
                <th style="padding:5px;">ESPECIAL</th>
            </tr>`;

    for (const cuit in desgloseEmpleadores) {
        const e = desgloseEmpleadores[cuit];
        const aE = Math.floor(e.meses.size / 12);
        const mE = e.meses.size % 12;
        tablaHtml += `
            <tr style="border-bottom:1px solid #ddd;">
                <td style="padding:5px;">${e.nombre}<br><small>${cuit}</small></td>
                <td style="padding:5px; text-align:center;">${aE}a ${mE}m</td>
                <td style="padding:5px; text-align:right;">$${e.remComun.toLocaleString('es-AR')}</td>
                <td style="padding:5px; text-align:right; color:var(--red);">${e.remEspecial > 0 ? '$'+e.remEspecial.toLocaleString('es-AR') : '-'}</td>
            </tr>`;
    }
    tablaHtml += `</table>`;

    const panel = document.getElementById('panel-resumen');
    panel.innerHTML = tablaHtml;
    panel.classList.remove('hidden');
    
    // Guardamos el texto del resumen total para el sheet
    panel.dataset.resumenTotal = `${anios}a ${meses}m | Prom: ${promedioTxt}`;
}

// ==========================================
// 2. GESTIN DE DATOS (CRUD)
// ==========================================
async function enviarDatos() {
    const dni = document.getElementById('dni').value;
    if(!dni) return alert("Falta DNI");
    toggleLoad(true);

    const moratorias = Array.from(document.querySelectorAll('.moratoria-item')).map(it => ({
        ley: it.querySelector('.m-ley').value,
        pactadas: it.querySelector('.m-pact').value,
        pagas: it.querySelector('.m-pagas').value
    }));

    // Convertimos el desglose a un formato JSON simple para guardar
    const detalleSimplificado = Object.keys(desgloseEmpleadores).map(cuit => ({
        cuit, 
        n: desgloseEmpleadores[cuit].nombre, 
        t: desgloseEmpleadores[cuit].meses.size 
    }));

    const payload = {
        action: "guardarExpediente",
        dni: dni,
        nombre: document.getElementById('nombre').value,
        fecha_nac: document.getElementById('fecha_nac').value,
        cuil: document.getElementById('cuil').value,
        clave_anses: document.getElementById('clave_anses').value,
        estado_civil: document.getElementById('estado_civil').value,
        hijos: document.getElementById('hijos').value,
        estado: document.getElementById('estado_tramite').value,
        moratorias: JSON.stringify(moratorias),
        notas: document.getElementById('notas').value,
        resumen_total: document.getElementById('panel-resumen').dataset.resumenTotal || "",
        resumen_detallado: JSON.stringify(detalleSimplificado),
        usuario: USER_ROLE
    };

    try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        alert("Guardado exitoso");
    } catch (e) { alert("Error al guardar"); }
    toggleLoad(false);
}

async function consultarExpediente() {
    const dni = document.getElementById('dni').value;
    if(!dni) return alert("DNI requerido");
    toggleLoad(true);
    try {
        const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "consultarDNI", dni: dni }) });
        const res = await r.json();
        if(res) {
            // Sincronizado con Estructura ver_03 (14 columnas)
            document.getElementById('nombre').value = res[2] || "";
            if (res[3]) {
                const f = new Date(res[3]);
                document.getElementById('fecha_nac').value = f.toISOString().split('T')[0];
            }
            document.getElementById('cuil').value = res[4] || "";
            document.getElementById('clave_anses').value = res[5] || "";
            document.getElementById('estado_civil').value = res[6] || "Soltero/a";
            document.getElementById('hijos').value = res[7] || "";
            document.getElementById('estado_tramite').value = res[8] || "Iniciado";
            
            document.getElementById('moratorias-wrapper').innerHTML = "";
            JSON.parse(res[9] || "[]").forEach(m => crearGrupoMoratoria(m));
            
            document.getElementById('notas').value = res[10] || "";
            
            // Visualizaci贸n del resumen guardado
            const panel = document.getElementById('panel-resumen');
            if(res[11]) {
                panel.innerHTML = `<div style="padding:10px; background:#f0f0f0; border-radius:5px;">
                    <strong>ltimo C贸mputo:</strong> ${res[11]}<br>
                    <small>Vuelva a pegar la s谩bana para actualizar desglose.</small>
                </div>`;
                panel.classList.remove('hidden');
            }

            actualizarEdad();
            alert("Expediente cargado");
        } else { alert("No se encontr贸 el DNI"); }
    } catch (e) { alert("Error de conexi贸n"); }
    toggleLoad(false);
}

// ==========================================
// 3. FUNCIONES DE INTERFAZ Y LOGIN
// ==========================================
async function ejecutarLogin() {
    const pin = document.getElementById('pass-input').value;
    toggleLoad(true);
    try {
        const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "login", pin: pin }) });
        const res = await r.json();
        if (res.success) {
            USER_ROLE = res.role;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            resetearTemporizador();
        } else { alert("PIN Incorrecto"); }
    } catch (e) { alert("Error"); }
    toggleLoad(false);
}

function mostrarSeccion(sec) {
    document.getElementById('sec-form').classList.add('hidden');
    document.getElementById('sec-agenda').classList.add('hidden');
    document.getElementById('sec-' + sec).classList.remove('hidden');
    if(sec === 'agenda') cargarAgenda();
}

function actualizarEdad() {
    const f = document.getElementById('fecha_nac').value;
    if(!f) return;
    const n = new Date(f), h = new Date();
    let e = h.getFullYear() - n.getFullYear();
    if (h.getMonth() < n.getMonth() || (h.getMonth() === n.getMonth() && h.getDate() < n.getDate())) e--;
    document.getElementById('edad-display').innerText = e + " a帽os";
}

function crearGrupoMoratoria(d = {}) {
    const div = document.createElement('div');
    div.className = "moratoria-item";
    div.style = "border:1px solid #ddd; padding:10px; margin-top:10px; background:#f9f9f9;";
    div.innerHTML = `
        <label>Ley</label><input type="text" class="m-ley" value="${d.ley||''}">
        <div class="row">
            <div style="flex:1"><label>Pactadas</label><input type="number" class="m-pact" value="${d.pactadas||''}"></div>
            <div style="flex:1"><label>Pagas</label><input type="number" class="m-pagas" value="${d.pagas||''}"></div>
        </div>
        <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer; font-size:11px;">[Eliminar]</button>
    `;
    document.getElementById('moratorias-wrapper').appendChild(div);
}

async function cargarAgenda() {
    toggleLoad(true);
    const lista = document.getElementById('agenda-lista');
    lista.innerHTML = "";
    try {
        const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "listarTodo" }) });
        const datos = await r.json();
        datos.forEach(c => {
            const item = document.createElement('div');
            item.className = "agenda-card";
            item.innerHTML = `<strong>${c[2]}</strong> (DNI: ${c[1]})<br><small>Estado: ${c[8]}</small>
            <div style="margin-top:10px;"><button class="btn btn-blue" style="padding:5px; width:auto;" onclick="editarDesdeAgenda('${c[1]}')">EDITAR</button></div>`;
            lista.appendChild(item);
        });
    } catch (e) {}
    toggleLoad(false);
}

function editarDesdeAgenda(dni) {
    document.getElementById('dni').value = dni;
    consultarExpediente();
    mostrarSeccion('form');
}

function limpiarFormulario() {
    document.querySelectorAll('input, textarea').forEach(i => i.value = "");
    document.getElementById('moratorias-wrapper').innerHTML = "";
    document.getElementById('panel-resumen').classList.add('hidden');
}

function toggleLoad(v) { document.getElementById('loading').className = v ? "" : "hidden"; }

function cerrarSesion() {
    USER_ROLE = "";
    document.getElementById('main-app').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
}

function resetearTemporizador() {
    clearTimeout(timeoutReloj);
    timeoutReloj = setTimeout(cerrarSesion, MINUTOS_INACTIVIDAD * 60 * 1000);
}

document.onmousemove = resetearTemporizador;
document.onkeypress = resetearTemporizador;
</script>

</script>

</body>
</html>
